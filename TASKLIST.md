# 不足機能の洗い出しとタスクリスト

このリポジトリは「6502 CPU + SDL2 デモ実行環境」としては動作していますが、`README.md` にある通りフル NES エミュレータではありません。
ここでは現状コードから見える不足機能を、実装優先度付きで整理します。

## 1. エミュレータ基盤

- [ ] **ROM ローダー実装（iNES/NES ヘッダ読込）**
  - 現在は `main.rs` にゲームバイトコードをハードコードしているため、外部 ROM を実行できない。
  - まずはファイル読込 + PRG ROM を CPU アドレス空間へマップする最小実装を追加する。

- [ ] **CPU コアをライブラリ化し、SDL フロントエンドと分離**
  - 実行環境（CLI/SDL）と CPU コアが密結合になっているため、再利用とテストがしづらい。
  - `lib.rs`（CPUコア）+ `bin`（デモ実行）構成へ分割する。

- [ ] **実行トレース（命令/レジスタ/フラグ）機能**
  - デバッグ時に命令単位の可視化がないため、問題切り分けに時間がかかる。
  - 実行ログ出力（オン/オフ可能）を実装する。

## 2. CPU 互換性・正確性

- [ ] **未対応命令検出の改善（`todo!()` 依存の解消）**
  - 未対応オペコード到達時に `todo!()` でクラッシュする。
  - `Result` ベースで未対応命令を返却し、どの命令が不足しているかを明示する。

- [ ] **割り込みフローの拡充（IRQ/NMI/BRK の明示的 API）**
  - RTI などはあるが、外部イベント起点で割り込みを発火するインターフェースがない。
  - `trigger_nmi` / `trigger_irq` などを追加し、スタック・ベクタ遷移を統一実装する。

- [ ] **サイクル計測とページクロス加算サイクル対応**
  - オペコード定義にサイクル情報はあるが、実行側でサイクル消費を管理していない。
  - 命令ごとの基本サイクル + 分岐成立/ページクロスの追加サイクルを反映する。

- [ ] **6502 メモリ空間サイズの見直し**
  - 現在の配列長は `0xffff`（65535）で、16bit アドレス全域（65536）を完全には表現できない。
  - `[u8; 0x10000]` に変更し、境界アクセスを含むテストを追加する。

## 3. NES 化に向けた拡張

- [ ] **PPU 最小実装（描画レジスタ/VRAM ミラーの骨格）**
  - 現在は `0x0200..0x05FF` を独自フレームバッファとして使用しており、NES PPU とは別仕様。
  - まずは CPU メモリマップ上の PPU レジスタ挙動の最小実装を行う。

- [ ] **APU/音声のスタブ実装**
  - 音声系 I/O が未実装。
  - まずはレジスタ書込受付のみのスタブを追加し、将来的な音源実装に備える。

- [ ] **Mapper 0（NROM）対応**
  - カートリッジごとのバンク切替機構が未対応。
  - 最初の対象として NROM 固定マッピングを実装する。

## 4. 品質・運用

- [ ] **SDL2 依存を分離し、CPU 単体テストをリンク不要で実行可能にする**
  - 現状 `cargo test` は環境に SDL2 ライブラリがないと失敗しやすい。
  - CPU コアを別クレート化して、CI でヘッドレステストを安定実行できる形にする。

- [ ] **既存 typo の解消（可読性向上）**
  - `read_screan_state` / `screan_state` など命名 typo が存在する。
  - `screen` 系へ統一し、検索性と保守性を上げる。

- [ ] **ドキュメント拡充（開発ロードマップ）**
  - README の「Possible next steps」は高レベルの箇条書きに留まる。
  - 本タスクリストを基に、マイルストーン/Done 条件/優先度を README から参照できる形で管理する。

## 推奨実施順（最初の 3 スプリント）

### Sprint 1（安定化）
- [ ] メモリ空間サイズ修正
- [ ] `todo!()` のエラーハンドリング化
- [ ] CPU と SDL の分離着手

### Sprint 2（観測性）
- [ ] 実行トレース実装
- [ ] サイクル計測導入
- [ ] typo 修正と命名統一

### Sprint 3（NES 入口）
- [ ] ROM ローダー
- [ ] Mapper 0（NROM）
- [ ] PPU 最小実装
